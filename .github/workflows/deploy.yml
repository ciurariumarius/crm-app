name: Deploy to CloudPanel

on:
  push:
    branches:
      - main # Trigger deployment when pushing to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}     # Your VPS IP address or Domain
          username: ${{ secrets.SERVER_USER }} # Your CloudPanel Site User (e.g., crm-user)
          password: ${{ secrets.SERVER_PASSWORD }} # Your Site User password (or use ssh_key instead)
          port: 22                             # Default SSH port
          script: |
            set -e # Stop script on first error

            # Navigate to the site folder (Update the domain to your actual folder name!)
            cd /home/${{ secrets.SERVER_USER }}/htdocs/crm.populatia.ro
            
            # Configure Git to trust the workspace folder
            git config --global --add safe.directory /home/${{ secrets.SERVER_USER }}/htdocs/crm.populatia.ro

            # Forcefully pull the latest code from GitHub, discarding local changes
            git fetch origin main
            git reset --hard origin/main
            
            # Install dependencies
            npm install --include=dev
            
            # Update Prisma ORM (if database schema changed)
            npx prisma generate
            npx prisma migrate deploy
            
            # Build the Next.js application
            npm run build
            
            # Restart the Next.js app (using global PM2 managed by CloudPanel)
            pm2 restart all || npx pm2 restart all
